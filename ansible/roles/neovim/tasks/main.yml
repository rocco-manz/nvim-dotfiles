---
# ─── System dependencies ──────────────────────────────────────────────

- name: Install system packages
  apt:
    name:
      - git
      - curl
      - wget
      - unzip
      - build-essential
      - ripgrep
      - fd-find
      - fzf
      - xclip
      - python3
      - python3-pip
      - python3-venv
      - luarocks
      - cmake
      - gettext
      - gnupg
      - ca-certificates
    state: present
    update_cache: true

# ─── Neovim (from GitHub releases — works on Debian 13) ───────────────

- name: Check if nvim is already installed
  command: nvim --version
  register: nvim_check
  ignore_errors: true
  changed_when: false

- name: Get installed nvim version
  set_fact:
    nvim_installed_version: "{{ nvim_check.stdout_lines[0] | regex_search('v([0-9.]+)', '\\1') | first | default('none') }}"
  when: nvim_check.rc == 0

- name: Set nvim_needs_install flag
  set_fact:
    nvim_needs_install: "{{ nvim_check.rc != 0 or (nvim_installed_version | default('none')) != nvim_version }}"

- name: Remove old nvim installation
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/nvim
    - /tmp/nvim.appimage
    - /tmp/squashfs-root
  when: nvim_needs_install

- name: Download Neovim appimage
  get_url:
    url: "https://github.com/neovim/neovim/releases/download/v{{ nvim_version }}/nvim-linux-x86_64.appimage"
    dest: /tmp/nvim.appimage
    mode: "0755"
  when: nvim_needs_install

- name: Extract appimage
  command: /tmp/nvim.appimage --appimage-extract
  args:
    chdir: /tmp
  when: nvim_needs_install

- name: Install nvim to /opt/nvim
  command: mv /tmp/squashfs-root /opt/nvim
  when: nvim_needs_install

- name: Symlink nvim binary
  file:
    src: /opt/nvim/usr/bin/nvim
    dest: /usr/local/bin/nvim
    state: link
    force: true

- name: Clean up appimage artifacts
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/nvim.appimage
    - /tmp/squashfs-root

# ─── Node.js (for LSPs) ───────────────────────────────────────────────

- name: Check if Node.js is installed
  command: node --version
  register: node_check
  ignore_errors: true
  changed_when: false

- name: Install NodeSource GPG key
  shell: |
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
  args:
    creates: /usr/share/keyrings/nodesource.gpg
  when: node_check.rc != 0

- name: Add NodeSource repository
  copy:
    content: "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ node_major }}.x nodistro main"
    dest: /etc/apt/sources.list.d/nodesource.list
  when: node_check.rc != 0

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: true
  when: node_check.rc != 0

- name: Install global npm packages
  npm:
    name: "{{ item }}"
    global: true
  loop:
    - neovim
    - tree-sitter-cli

# ─── Python neovim provider ───────────────────────────────────────────

- name: Install pynvim
  pip:
    name: pynvim
    extra_args: "--break-system-packages"
  become: true
  become_user: "{{ nvim_user }}"

# ─── Neovim config ────────────────────────────────────────────────────

- name: Check existing nvim config
  stat:
    path: "{{ nvim_home }}/.config/nvim"
  register: nvim_config_stat
  become: true
  become_user: "{{ nvim_user }}"

- name: Backup existing nvim config (if present and not a symlink)
  command: "mv {{ nvim_home }}/.config/nvim {{ nvim_home }}/.config/nvim.bak.{{ ansible_date_time.epoch }}"
  become: true
  become_user: "{{ nvim_user }}"
  when: nvim_config_stat.stat.exists and not nvim_config_stat.stat.islnk

- name: Ensure .config directory exists
  file:
    path: "{{ nvim_home }}/.config"
    state: directory
    owner: "{{ nvim_user }}"
    mode: "0755"
  become: true
  become_user: "{{ nvim_user }}"

- name: Sync nvim config from repo
  copy:
    src: "{{ playbook_dir }}/../nvim/"
    dest: "{{ nvim_home }}/.config/nvim/"
    owner: "{{ nvim_user }}"
    mode: preserve
  become: true

- name: Ensure correct ownership of nvim config
  file:
    path: "{{ nvim_home }}/.config/nvim"
    state: directory
    recurse: true
    owner: "{{ nvim_user }}"
  become: true

# ─── Clean plugin state ───────────────────────────────────────────────

- name: Remove stale nvim data dirs for clean plugin install
  file:
    path: "{{ nvim_home }}/{{ item }}"
    state: absent
  loop:
    - .local/share/nvim
    - .cache/nvim
    - .local/state/nvim
  become: true
  become_user: "{{ nvim_user }}"
  tags: [clean]

# ─── Bootstrap plugins ────────────────────────────────────────────────

- name: Bootstrap Lazy.nvim and sync plugins
  shell: "nvim --headless -c 'Lazy! sync' -c 'qa!' 2>&1 || true"
  become: true
  become_user: "{{ nvim_user }}"
  environment:
    HOME: "{{ nvim_home }}"
  register: lazy_sync
  changed_when: true
  timeout: 300

- name: Install Treesitter parsers
  shell: "nvim --headless -c 'TSUpdate' -c 'sleep 15' -c 'qa!' 2>&1 || true"
  become: true
  become_user: "{{ nvim_user }}"
  environment:
    HOME: "{{ nvim_home }}"
  ignore_errors: true
  timeout: 300
